{% extends "admin_layout.html" %}

{% block title %}Manajemen Pengguna{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-label">Total Pengguna</div>
        <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat-card success">
        <div class="stat-label">Pengguna Aktif</div>
        <div class="stat-value">{{ stats.active }}</div>
    </div>
    <div class="stat-card warning">
        <div class="stat-label">Non-Aktif</div>
        <div class="stat-value">{{ stats.inactive }}</div>
    </div>
    <div class="stat-card gold">
        <div class="stat-label">Role Types</div>
        <div class="stat-value">{{ stats.by_role | length }}</div>
    </div>
</div>

<!-- Quick Actions & Filter -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">üîç Filter & Aksi</h3>
        <button class="btn btn-primary" onclick="showAddUserModal()">‚ûï Tambah User Baru</button>
    </div>
    <div style="padding: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
        <select id="roleFilter" class="form-control" onchange="filterUsers()" style="width: auto; min-width: 200px;">
            <option value="">Semua Role</option>
            {% for role_code, role_info in roles.items() %}
            <option value="{{ role_code }}">{{ role_info.label }}</option>
            {% endfor %}
        </select>
        <input type="text" id="searchUser" class="form-control" placeholder="Cari nama atau email..."
            onkeyup="filterUsers()" style="width: auto; flex-grow: 1;">
    </div>
</div>

<!-- User List -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üë• Daftar Pengguna</h3>
    </div>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Terdaftar</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="userTable">
                {% for user in users %}
                <tr data-role="{{ user.role }}" data-name="{{ user.name.lower() }} {{ user.email.lower() }}">
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div
                                style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                {{ user.name[0] }}
                            </div>
                            <div>
                                <div style="font-weight: 600;">{{ user.name }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">{{ user.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge" style="background: rgba(15, 76, 117, 0.1); color: var(--primary-color);">
                            {{ roles[user.role].label if user.role in roles else user.role }}
                        </span>
                        {% if user.assigned_area %}
                        <div style="font-size: 11px; margin-top: 4px; color: var(--text-secondary);">üìç {{
                            user.assigned_area }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="badge badge-success">Aktif</span>
                        {% else %}
                        <span class="badge badge-warning">Non-Aktif</span>
                        {% endif %}
                    </td>
                    <td style="font-size: 13px;">{{ user.created_at[:10] }}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-info" onclick="editUser({{ user.id }})"
                                title="Edit Role">‚úèÔ∏è</button>
                            {% if user.username != 'superadmin' %}
                            <form action="{{ url_for('toggle_user_active', user_id=user.id) }}" method="POST"
                                style="display:inline;">
                                <button type="submit"
                                    class="btn btn-sm {{ 'btn-warning' if user.is_active else 'btn-success' }}"
                                    title="{{ 'Non-aktifkan' if user.is_active else 'Aktifkan' }}">
                                    {{ '‚õî' if user.is_active else '‚úÖ' }}
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; width: 500px; max-width: 90%;">
        <h3 id="modalTitle" style="margin-bottom: 20px;">Tambah User Baru</h3>
        <form id="userForm" method="POST" action="{{ url_for('create_user') }}">
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" name="name" id="userName" class="form-control" required>
            </div>
            <div class="grid-2" style="gap: 15px;">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" id="userEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" id="userUsername" class="form-control" required>
                </div>
            </div>
            <div class="grid-2" style="gap: 15px;">
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" id="userPassword" class="form-control"
                        placeholder="Isi untuk ubah password">
                </div>
                <div class="form-group">
                    <label>No. HP (Opsional)</label>
                    <input type="text" name="phone" id="userPhone" class="form-control">
                </div>
            </div>
            <div class="form-group">
                <label>URL Foto Profil (Opsional)</label>
                <input type="text" name="profile_image" id="userImage" class="form-control" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select name="role" id="userRole" class="form-control" required>
                    {% for role_code, role_info in roles.items() %}
                    <option value="{{ role_code }}">{{ role_info.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" id="areaGroup" style="display: none;">
                <label>Area Penugasan (Opsional)</label>
                <input type="text" name="assigned_area" id="userArea" class="form-control"
                    placeholder="Contoh: Zona Selatan">
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Batal</button>
                <button type="submit" class="btn btn-primary">Simpan</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('userRole').addEventListener('change', function () {
        const role = this.value;
        const areaGroup = document.getElementById('areaGroup');
        if (['area_manager', 'regional_admin'].includes(role)) {
            areaGroup.style.display = 'block';
        } else {
            areaGroup.style.display = 'none';
            document.getElementById('userArea').value = '';
        }
    });

    function showAddUserModal() {
        document.getElementById('modalTitle').innerText = "Tambah User Baru";
        document.getElementById('userForm').action = "{{ url_for('create_user') }}";
        document.getElementById('userForm').reset();
        document.getElementById('userPassword').required = true;
        document.getElementById('userModal').style.display = 'flex';
    }

    function editUser(id) {
        fetch(`/api/users/${id}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('modalTitle').innerText = "Edit User";
                document.getElementById('userForm').action = `/admin/users/${id}/update`;

                document.getElementById('userName').value = data.name;
                document.getElementById('userName').disabled = false;
                document.getElementById('userEmail').value = data.email;
                document.getElementById('userEmail').disabled = false;
                document.getElementById('userUsername').value = data.username;
                document.getElementById('userUsername').disabled = false;
                document.getElementById('userPhone').value = data.phone || '';
                document.getElementById('userPhone').disabled = false;
                document.getElementById('userImage').value = data.profile_image || '';
                document.getElementById('userPassword').disabled = false;
                document.getElementById('userPassword').required = false;

                document.getElementById('userRole').value = data.role;
                document.getElementById('userArea').value = data.assigned_area || '';

                document.getElementById('userRole').dispatchEvent(new Event('change'));

                document.getElementById('userModal').style.display = 'flex';
            });
    }

    function closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    function filterUsers() {
        const role = document.getElementById('roleFilter').value;
        const search = document.getElementById('searchUser').value.toLowerCase();

        document.querySelectorAll('#userTable tr').forEach(row => {
            const rowRole = row.dataset.role;
            const rowName = row.dataset.name;

            const roleMatch = !role || rowRole === role;
            const searchMatch = !search || rowName.includes(search);

            row.style.display = roleMatch && searchMatch ? '' : 'none';
        });
    }
</script>
{% endblock %}